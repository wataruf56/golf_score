<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ゴルフスコア管理</title>
  <style>
    :root { --bg1:#5951c2; --bg2:#6a5fd6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#4f46e5; --primary-2:#5b6fe6; --ok:#16a34a; --danger:#ef4444; }
    html,body{height:100%;}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",'Noto Sans JP',Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, var(--bg2), transparent 60%),
                  radial-gradient(1200px 800px at 120% 110%, var(--bg1), transparent 60%),
                  linear-gradient(180deg, #4c4fb6, #6e60e0);
      color:var(--text);
    }
    .wrap{max-width:560px;margin:32px auto;padding:0 16px;}
    .title{color:#fff;text-align:center;font-weight:700;font-size:28px;margin:8px 0 24px;}
    .card{
      background:var(--card); border-radius:16px; box-shadow:0 20px 45px rgba(0,0,0,.15); padding:28px; margin:0 auto 24px;
    }
    h2{margin:0 0 12px; font-size:22px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type="email"], input[type="password"], input[type="text"], input[type="date"], input[type="number"]{
      width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; outline:none; box-sizing:border-box; background:#fff;
    }
    input:focus{border-color:#a5b4fc; box-shadow:0 0 0 3px rgba(99,102,241,.2)}
    .btn{width:100%; padding:12px 14px; border:none; border-radius:10px; font-weight:700; font-size:16px; cursor:pointer}
    .btn-primary{background:var(--primary); color:#fff}
    .btn-primary:hover{opacity:.95}
    .btn-secondary{background:#22c55e; color:#fff}
    .btn-secondary:hover{opacity:.95}
    .btn-danger{background:#f87171; color:#fff}
    .muted{color:var(--muted); font-size:14px}
    .center{text-align:center}
    .link{color:var(--primary-2); text-decoration:none}
    .link:hover{text-decoration:underline}
    .message{margin-top:14px; padding:12px 14px; border-radius:10px; font-size:14px}
    .message.ok{background:#ecfdf5; color:#064e3b; border:1px solid #a7f3d0}
    .message.err{background:#fef2f2; color:#7f1d1d; border:1px solid #fecaca}
    .scores-card{background:var(--card); border-radius:16px; box-shadow:0 20px 45px rgba(0,0,0,.15); padding:22px;}
    .score-item{display:flex; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid #f1f5f9}
    .score-item:last-child{border-bottom:none}
    .topbar{color:#fff; text-align:center; font-weight:700; margin-bottom:10px}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:520px){ .row-2{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="topbar" class="topbar"></div>

    <!-- 認証カード -->
    <div id="authCard" class="card">
      <h2>ゴルフスコア管理</h2>
      <div class="row">
        <div>
          <label for="email">メールアドレス</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="username" />
        </div>
        <div>
          <label for="password">パスワード</label>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" onclick="signUp()">新規登録</button>
        <button class="btn btn-secondary" onclick="signIn()">ログイン</button>
      </div>
      <p class="center" style="margin-top:8px">
        <a class="link" href="javascript:void(0)" onclick="resetPassword()">パスワードを忘れた？</a>
      </p>
      <div id="authMsg"></div>
    </div>

    <!-- アプリ本体 -->
    <div id="appCard" class="card" style="display:none">
      <h2>スコア入力</h2>
      <div class="row row-2">
        <div>
          <label for="date">日付</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="course">コース名</label>
          <input id="course" type="text" placeholder="〇〇ゴルフクラブ" />
        </div>
        <div>
          <label for="score">スコア</label>
          <input id="score" type="number" inputmode="numeric" placeholder="72" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" onclick="saveScore()">スコアを保存</button>
        <button class="btn btn-danger"  onclick="logOut()">ログアウト</button>
      </div>
      <div id="appMsg"></div>
    </div>

    <!-- 保存済みスコア -->
    <div id="scoresWrap" class="scores-card" style="display:none">
      <h2>保存したスコア</h2>
      <div id="scoresList" class="muted">まだスコアがありません</div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    // === ここをあなたの現在の firebaseConfig に置き換えてください ===
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    // ===============================================================

    // Firebase 初期化
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // UI ヘルパ
    const $ = (id)=>document.getElementById(id);
    const fmt = (d)=> new Date(d).toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'});

    function showMessage(elId, text, type='ok'){
      const el = $(elId);
      if(!text){ el.innerHTML=''; return; }
      el.innerHTML = `<div class="message ${type==='ok'?'ok':'err'}">${text}</div>`;
    }

    function friendlyAuthError(err){
      const code = (err && err.code) ? String(err.code) : "";
      const map = {
        "auth/invalid-credential": "メールアドレスまたはパスワードが違います。",
        "auth/user-not-found": "このメールアドレスは登録がありません。",
        "auth/wrong-password": "メールアドレスまたはパスワードが違います。",
        "auth/invalid-email": "メールアドレスの形式が正しくありません。",
        "auth/too-many-requests": "試行が多すぎます。しばらく時間をおいて再度お試しください。",
        "auth/email-already-in-use": "このメールアドレスは既に登録されています。",
        "auth/weak-password": "パスワードは6文字以上にしてください。",
        "default": "処理に失敗しました。入力内容をご確認ください。"
      };
      return map[code] || map.default;
    }

    // 認証状態の監視
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        // ログイン時
        $("authCard").style.display = "none";
        $("appCard").style.display  = "";
        $("scoresWrap").style.display = "";
        $("topbar").textContent = `ログイン中: ${user.email ?? user.uid}`;

        // 日付初期値
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        $("date").value = `${yyyy}-${mm}-${dd}`;

        await loadScores();
      }else{
        // 未ログイン時
        $("authCard").style.display = "";
        $("appCard").style.display  = "none";
        $("scoresWrap").style.display = "none";
        $("topbar").textContent = "";
        showMessage("authMsg","", "ok");
      }
    });

    // 新規登録
    window.signUp = async ()=>{
      const email = $("email").value.trim();
      const pass  = $("password").value;
      showMessage("authMsg", "");
      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        showMessage("authMsg", "アカウントを作成しました。", "ok");
      }catch(err){
        showMessage("authMsg", friendlyAuthError(err), "err");
      }
    };

    // ログイン
    window.signIn = async ()=>{
      const email = $("email").value.trim();
      const pass  = $("password").value;
      showMessage("authMsg", "");
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        showMessage("authMsg", friendlyAuthError(err), "err");
      }
    };

    // パスワード再設定
    window.resetPassword = async ()=>{
      const email = $("email").value.trim();
      if(!email){
        showMessage("authMsg","まずメールアドレスを入力してください。","err");
        return;
      }
      try{
        await sendPasswordResetEmail(auth, email);
        showMessage("authMsg","パスワード再設定用のメールを送信しました。メールをご確認ください。","ok");
      }catch(err){
        showMessage("authMsg", friendlyAuthError(err), "err");
      }
    };

    // ログアウト
    window.logOut = async ()=>{
      await signOut(auth);
    };

    // スコア保存
    window.saveScore = async ()=>{
      const user = auth.currentUser;
      if(!user){ return; }

      const date  = $("date").value;
      const course= $("course").value.trim();
      const score = Number($("score").value);

      if(!date || !course || !score){
        showMessage("appMsg", "日付・コース名・スコアを入力してください。", "err");
        return;
      }

      try{
        await addDoc(collection(db, "scores"), {
          uid: user.uid,
          email: user.email ?? null,
          date,
          course,
          score,
          createdAt: serverTimestamp()
        });
        showMessage("appMsg","保存しました。","ok");
        $("course").value = "";
        $("score").value  = "";
        await loadScores();
      }catch(err){
        showMessage("appMsg","保存に失敗しました。権限設定（Firestore ルール）をご確認ください。","err");
      }
    };

    // スコア読み込み
    async function loadScores(){
      const user = auth.currentUser;
      if(!user) return;
      const q = query(
        collection(db, "scores"),
        where("uid","==", user.uid),
        orderBy("date","desc")
      );
      const snap = await getDocs(q);
      const listEl = $("scoresList");

      if(snap.empty){
        listEl.className = "muted";
        listEl.textContent = "まだスコアがありません";
        return;
      }

      const items = [];
      snap.forEach(doc=>{
        const d = doc.data();
        items.push(`
          <div class="score-item">
            <div>${fmt(d.date)}</div>
            <div>${d.course ?? "-"}</div>
            <div><strong>${d.score}</strong></div>
          </div>
        `);
      });
      listEl.className = "";
      listEl.innerHTML = items.join("");
    }
  </script>
</body>
</html>
